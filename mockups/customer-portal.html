<!DOCTYPE html>
<html>
<head>
    <title>Customer Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Styles for header */
        .header {
            background-color: #fff;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header .logo-text {
            color: #333;
            font-size: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        /* Styles for the punchcard gallery and detailed section */
        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .punchcard-gallery {
            display: flex;
            overflow-x: auto;
            padding: 20px;
        }
        .punchcard {
            flex: 0 0 auto;
            width: 240px;
            height: 160px;
            margin: 10px;
            border-radius: 10px;
            position: relative;
            text-align: left;
            cursor: pointer;
            transition: transform 0.3s ease;
            background-size: cover;
            background-position: center;
        }
        .punchcard:hover {
            transform: translateY(-10px);
        }
        .punchcard-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 91.75%;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            padding: 5px 10px;
            font-size: 16px;
            font-weight: 600;
        }
        .punchcard-info {
            background-color: #fff;
            padding: 20px;
            max-width: 95%; /* Set a maximum width for the container */
            margin: 20px auto; /* Center the container */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            box-sizing: border-box; /* Include padding in total width */
        }
        .punchcard-business {
            font-weight: bold;
            font-size: 24px;
        }
        .punchcard-description {
            font-size: 16px;
            color: #777;
        }
        /* Styles for the progress bar */
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: linear-gradient(to right, #50c878, #f0f0f0);
            border-radius: 10px;
            position: relative;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #50c878;
            border-radius: 10px;
        }
        .progress-label {
            text-align: center;
            font-size: 14px;
           
color: #333;
margin-top: 5px;
}
.progress-percentage {
position: absolute;
top: -20px;
left: 50%;
transform: translateX(-50%);
font-size: 12px;
color: #333;
}
/* Styles for the select target reward section */
.reward-selection-container {
margin: 20px 0;
}
.reward-selection-label {
font-size: 16px;
margin-bottom: 5px;
}
.reward-selection-dropdown {
width: 100%;
padding: 5px;
font-size: 16px;
}
.progress-label {
    margin: 10px;
}
</style>

<script src="https://unpkg.com/aws-sdk@2.799.0/dist/aws-sdk.min.js"></script>
<script src="https://unpkg.com/amazon-cognito-identity-js@4.6.0/dist/amazon-cognito-identity.min.js"></script>
 <!-- Include the API Gateway SDK scripts -->
<script type="text/javascript" src="../lib/axios/dist/axios.standalone.js"></script>
<script type="text/javascript" src="../lib/CryptoJS/rollups/hmac-sha256.js"></script>
<script type="text/javascript" src="../lib/CryptoJS/rollups/sha256.js"></script>
<script type="text/javascript" src="../lib/CryptoJS/components/hmac.js"></script>
<script type="text/javascript" src="../lib/CryptoJS/components/enc-base64.js"></script>
<script type="text/javascript" src="../lib/url-template/url-template.js"></script>
<script type="text/javascript" src="../lib/apiGatewayCore/sigV4Client.js"></script>
<script type="text/javascript" src="../lib/apiGatewayCore/apiGatewayClient.js"></script>
<script type="text/javascript" src="../lib/apiGatewayCore/simpleHttpClient.js"></script>
<script type="text/javascript" src="../lib/apiGatewayCore/utils.js"></script>
<script type="text/javascript" src="../apigClient.js"></script>
<script type="text/javascript" src="../app.js"></script>

</head>
<body>
    <!-- Header -->
    <div class="header">
        <!-- Logo and navigation links -->
        <div class="logo-text">Punchcard</div>
    </div>
<div class="punchcard-gallery" id="punchcard-gallery">
    <!-- Punchcards will be dynamically generated here using JavaScript -->
</div>
<div class="punchcard-info" id="punchcard-info">
    <h1 id="name"></h1>
    <img id="profile-picture" src="" alt="Profile Picture">
    <p id="address"></p>
    <p id="phone-number"></p>
    <p id="description"></p>
    <button id="join-rewards-button" style="display: none;">Join Rewards Program!</button>
    <div id="rewards-status"></div>
    <div id="rewards-program-info"></div>
</div>

<script>
    // Sample data for punchcards (this can be replaced with data from an API call)
    const punchcardsData = [
        {
            business: 'Roti Roll',
            description: 'Earn rewards for every purchase!',
            backgroundImage: 'https://spicecravings.com/wp-content/uploads/2020/12/Chicken-Kathi-Roll-1.jpg',
            points: 6,
            rewards: [
                {points: 5, reward: 'Free Drink'},
                {points: 10, reward: 'Free Roll'},
                {points: 15, reward: 'Free Meal'}
            ],
        },
        // ... more punchcards
    ];

    var apigClient = apigClientFactory.newClient();

    apigClient.programsEnrolledProgramsUseridGet({userid: localStorage.getItem('userID')}, {}, {}).then(function(result){
        generatePunchcards(result.data);
    }).catch(function(result){
        console.log(result);
    }
    );

    // Function to generate punchcards in the gallery based on data
    function generatePunchcards(punchcardsData) {
        const punchcardGallery = document.getElementById('punchcard-gallery');
        const punchcardInfo = document.getElementById('punchcard-info');
        const punchcardBusiness = document.getElementById('name');  // changed 'punchcard-business' to 'name'
        const punchcardDescription = document.getElementById('punchcard-description');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentageLabel = document.getElementById('progress-percentage');
        const progressLabel = document.getElementById('progress-label');
        const rewardSelectionDropdown = document.getElementById('reward-selection-dropdown');

        punchcardsData.forEach((punchcard) => {
            // Create punchcard element
            const punchcardElement = document.createElement('div');
            punchcardElement.className = 'punchcard';
            punchcardElement.style.backgroundImage = `url(${punchcard["picture"]})`;
            punchcardElement.innerHTML = `
                <div class
="punchcard-strip">${punchcard["name"]}</div>`;

            // Event listener for when a punchcard is clicked
            punchcardElement.addEventListener('click', () => {
                punchcardBusiness.textContent = punchcard["name"];
                punchcardDescription.textContent = punchcard["custom:descriptionText"];
                punchcardInfo.style.display = 'block';

                // // Populate reward selection dropdown
                // rewardSelectionDropdown.innerHTML = '';
                // punchcard.rewards.forEach(reward => {
                //     const option = document.createElement('option');
                //     option.value = reward.points;
                //     option.text = `${reward.reward} (${reward.points} points)`;
                //     rewardSelectionDropdown.add(option);
                // });

                // Set initial progress bar and labels based on the first reward
                // updateProgressBarAndLabels(punchcard, punchcard.rewards[0].points);
            });

            // Event listener for when a reward is selected from the dropdown
            // rewardSelectionDropdown.addEventListener('change', () => {
            //     const targetPoints = parseInt(rewardSelectionDropdown.value);
            //     updateProgressBarAndLabels(punchcard, targetPoints);
            // });

            // Append punchcard to the gallery
            punchcardGallery.appendChild(punchcardElement);
        });

        // Hide punchcard info section initially
        punchcardInfo.style.display = 'none';
    }

    // Function to update progress bar and labels based on selected reward
    function updateProgressBarAndLabels(punchcard, targetPoints) {
        const progressBar = document.getElementById('progress-bar');
        const progressPercentageLabel = document.getElementById('progress-percentage');
        const progressLabel = document.getElementById('progress-label');

        const points = punchcard.points;
        const progressPercentage = (points / targetPoints) * 100;

        // Animate the progress bar to fill up
        progressBar.animate([
            { width: '0%' },
            { width: `${Math.min(100, progressPercentage)}%` }
        ], {
            duration: 1000,
            fill: 'forwards'
        });

        // Set progress percentage label and reward label
        progressPercentageLabel.textContent = `${Math.round(progressPercentage)}%`;
        const nextReward = punchcard.rewards.find(reward => reward.points === targetPoints);
        // progressLabel.textContent = `Next Reward: ${nextReward.reward} at ${targetPoints} points`;
    }

    // Generate punchcards based on the sample data
    ///generatePunchcards(punchcardsData);



    window.onload = function () {
            var apigClient = apigClientFactory.newClient();  // Replace with your API Gateway client initialization

            // Get the userID from localStorage and restaurantID from the URL parameters
            var userID = localStorage.getItem("userID");
            var urlParams = new URLSearchParams(window.location.search);
            var restaurantID = urlParams.get('restaurantID');

            // Check if the user is enrolled in the rewards program for the restaurant
            apigClient.programsEnrolledProgramsUseridGet({ userid: userID }, {}, {})
                .then(response => {
                    console.log(response)
                    var enrolledPrograms = response.data;
                    var isEnrolled = enrolledPrograms.some(program => program.restaurantID === restaurantID);

                    console.log("isEnrolled: " + isEnrolled)
                    if (isEnrolled) {
                        // User is enrolled, retrieve rewards program information
                        var instanceID = userID + restaurantID;
                        console.log(instanceID)
                        return apigClient.programsInstancesInstanceidGet({ instanceid: instanceID }, {}, {});
                    } else {
                        // User is not enrolled, display the "Join Rewards Program!" button
                        document.getElementById('join-rewards-button').style.display = 'block';
                        return null;
                    }
                })
                .then(response => {
                    if (response) {
                        var programData = response.data;

                        var rewardsProgramInfoDiv = document.getElementById('rewards-program-info');
                        rewardsProgramInfoDiv.innerHTML = '';

                        var progressBarContainer = document.createElement('div');
                        progressBarContainer.className = 'progress-bar-container';
                        rewardsProgramInfoDiv.appendChild(progressBarContainer);

                        var progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        progressBarContainer.appendChild(progressBar);

                        var maxPoints = JSON.parse(programData.rewardTiers[programData.rewardTiers.length - 1].replace(/'/g, '"')).tierPoints;
                        for (var i = 100; i <= maxPoints; i += 100) {
                            var marker = document.createElement('div');
                            marker.className = 'marker100';
                            marker.style.left = (i / maxPoints * 100) + '%';
                            progressBarContainer.appendChild(marker);

                            var markerLabel = document.createElement('div');
                            markerLabel.className = 'marker-label100';
                            markerLabel.textContent = i;
                            markerLabel.style.left = (i / maxPoints * 100) + '%';
                            progressBarContainer.appendChild(markerLabel);
                        }

                        var currentPointsLabel = document.createElement('div');
                        currentPointsLabel.className = 'current-points';
                        currentPointsLabel.textContent = programData.pointsEarned;
                        currentPointsLabel.style.left = (programData.pointsEarned / maxPoints * 100) + '%';
                        progressBarContainer.appendChild(currentPointsLabel);

                        var progressPercentage = Math.min((programData.pointsEarned / maxPoints) * 100, 100);
                        progressBar.style.width = progressPercentage + '%';

                        programData.rewardTiers.forEach((tierStr, index) => {
                        var tier = JSON.parse(tierStr.replace(/'/g, '"'));

                        var rewardTierDiv = document.createElement('div');
                        rewardTierDiv.className = 'reward-tier';
                        rewardsProgramInfoDiv.appendChild(rewardTierDiv);

                        var tierLabel = document.createElement('div');
                        tierLabel.className = 'tier-label';
                        tierLabel.textContent = 'Tier ' + (index + 1) + ': ' + tier.tierPoints + ' points - ' + tier.tierReward;
                        rewardTierDiv.appendChild(tierLabel);

                        var redeemButton = document.createElement('button');
                        if (programData.pointsEarned >= tier.tierPoints) {
                            redeemButton.textContent = 'Redeem';

                            // Updated event listener
                            redeemButton.addEventListener('click', function () {
                                var body = {
                                    'restaurantID': urlParams.get('restaurantID'),  // replace with actual restaurant ID
                                    'userID': localStorage.getItem("userID"),  // replace with actual user ID
                                    'amountUsed': tier.tierPoints,  // amount of points used for redemption
                                    'rewardRedeemed': tier.tierReward  // the reward that is being redeemed
                                };
                                console.log("body is", body);

                                apigClient.redemptionPost({}, body, {})
                                    .then(response => {
                                        alert('Reward redeemed successfully');
                                        // You may also want to update the rewards UI here
                                    })
                                    .catch(error => console.error('Error:', error));
                            });
                        } else {
                            redeemButton.textContent = 'Redeem (Not enough points)';
                            redeemButton.disabled = true;
                        }
                        rewardTierDiv.appendChild(redeemButton);
                    });
                }
            })

        .catch(error => console.error('Error:', error));

            document.getElementById('join-rewards-button').addEventListener('click', function () {
                var body = {
                    userID: userID,
                    restaurantID: restaurantID
                };

                apigClient.programsEnrolledProgramsPost({}, body, {})
                    .then(response => {
                        document.getElementById('rewards-status').textContent = 'You are now enrolled in the rewards program at this restaurant.';
                        document.getElementById('join-rewards-button').style.display = 'none';
                    })
                    .catch(error => console.error('Error:', error));
            });



            apigClient.restaurantsRestaurantIDGet({ restaurantID: restaurantID }, {}, {})
                .then(response => {
                    var data = response.data;
                    console.log(data);
                    document.getElementById('name').textContent = data.name;
                    document.getElementById('profile-picture').src = data.picture;
                    document.getElementById('address').textContent = data.address;
                    document.getElementById('phone-number').textContent = data.phoneNumber;
                    document.getElementById('description').textContent = data["custom:descriptionText"];
                })
                .catch(error => console.error('Error:', error));


        };
        
</script>
</body>
</html>