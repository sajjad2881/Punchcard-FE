<!DOCTYPE html>
<html>

<head>
    <title>Restaurant Profile</title>
    <style>
        #restaurant-profile {
            text-align: center;
        }

        #profile-picture {
            width: 200px;
            height: 200px;
        }
        .reward-tier {
            margin: 20px 0;
            width: 100%;
        }
        .reward-tier .tier-label {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .reward-tier .progress-bar-container {
            background-color: #eee;
            height: 20px;
            width: 100%;
            border-radius: 10px;
        }
        .reward-tier .progress-bar {
            background-color: #4CAF50;
            height: 20px;
            width: 0;
            border-radius: 10px;
        }
    </style>
    <script src="https://unpkg.com/aws-sdk@2.799.0/dist/aws-sdk.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@4.6.0/dist/amazon-cognito-identity.min.js"></script>
    <!-- Include the API Gateway SDK scripts -->
    <script type="text/javascript" src="../lib/axios/dist/axios.standalone.js"></script>
    <script type="text/javascript" src="../lib/CryptoJS/rollups/hmac-sha256.js"></script>
    <script type="text/javascript" src="../lib/CryptoJS/rollups/sha256.js"></script>
    <script type="text/javascript" src="../lib/CryptoJS/components/hmac.js"></script>
    <script type="text/javascript" src="../lib/CryptoJS/components/enc-base64.js"></script>
    <script type="text/javascript" src="../lib/url-template/url-template.js"></script>
    <script type="text/javascript" src="../lib/apiGatewayCore/sigV4Client.js"></script>
    <script type="text/javascript" src="../lib/apiGatewayCore/apiGatewayClient.js"></script>
    <script type="text/javascript" src="../lib/apiGatewayCore/simpleHttpClient.js"></script>
    <script type="text/javascript" src="../lib/apiGatewayCore/utils.js"></script>
    <script type="text/javascript" src="../apigClient.js"></script>
</head>

<body>
    <div id="restaurant-profile">
        <h1 id="name"></h1>
        <img id="profile-picture" src="" alt="Profile Picture">
        <p id="address"></p>
        <p id="phone-number"></p>
        <p id="description"></p>
        <button id="join-rewards-button" style="display: none;">Join Rewards Program!</button>
        <div id="rewards-status"></div>
        <div id="rewards-program-info"></div>
    </div>

    <script>
        window.onload = function () {
            var apigClient = apigClientFactory.newClient();  // Replace with your API Gateway client initialization

            // Get the userID from localStorage and restaurantID from the URL parameters
            var userID = localStorage.getItem("userID");
            var urlParams = new URLSearchParams(window.location.search);
            var restaurantID = urlParams.get('restaurantID');

            // Check if the user is enrolled in the rewards program for the restaurant
            apigClient.programsEnrolledProgramsUseridGet({ userid: userID }, {}, {})
                .then(response => {
                    console.log(response)
                    var enrolledPrograms = response.data;
                    var isEnrolled = enrolledPrograms.some(program => program.restaurantID === restaurantID);

                    console.log("isEnrolled: " + isEnrolled)
                    if (isEnrolled) {
                        // User is enrolled, retrieve rewards program information
                        var instanceID = userID + restaurantID;
                        console.log(instanceID)
                        return apigClient.programsInstancesInstanceidGet({ instanceid: instanceID }, {}, {});
                    } else {
                        // User is not enrolled, display the "Join Rewards Program!" button
                        document.getElementById('join-rewards-button').style.display = 'block';
                        return null;
                    }
                })
                .then(response => {
                    if (response) {
                        var programData = response.data;

                        var rewardsProgramInfoDiv = document.getElementById('rewards-program-info');
                        rewardsProgramInfoDiv.innerHTML = '';

                        for (var i = 0; i < programData.rewardTiers.length; i++) {
                            var tier = JSON.parse(programData.rewardTiers[i]);
                            var tierDiv = document.createElement('div');
                            tierDiv.className = 'reward-tier';

                            var tierLabel = document.createElement('p');
                            tierLabel.className = 'tier-label';
                            tierLabel.textContent = tier.tierReward + ' (' + tier.tierPoints + ' points)';
                            tierDiv.appendChild(tierLabel);

                            var progressBarContainer = document.createElement('div');
                            progressBarContainer.className = 'progress-bar-container';
                            tierDiv.appendChild(progressBarContainer);

                            var progressBar = document.createElement('div');
                            progressBar.className = 'progress-bar';
                            var progressPercentage = Math.min((programData.pointsEarned / tier.tierPoints) * 100, 100);
                            progressBar.style.width = progressPercentage + '%';
                            progressBarContainer.appendChild(progressBar);

                            rewardsProgramInfoDiv.appendChild(tierDiv);
                        }
                    }
                })
                .catch(error => console.error('Error:', error));

            document.getElementById('join-rewards-button').addEventListener('click', function () {
                var body = {
                    userID: userID,
                    restaurantID: restaurantID
                };

                apigClient.programsEnrolledProgramsPost({}, body, {})
                    .then(response => {
                        document.getElementById('rewards-status').textContent = 'You are now enrolled in the rewards program at this restaurant.';
                        document.getElementById('join-rewards-button').style.display = 'none';
                    })
                    .catch(error => console.error('Error:', error));
            });



            apigClient.restaurantsRestaurantIDGet({ restaurantID: restaurantID }, {}, {})
                .then(response => {
                    var data = response.data;
                    console.log(data);
                    document.getElementById('name').textContent = data.name;
                    document.getElementById('profile-picture').src = data.picture;
                    document.getElementById('address').textContent = data.address;
                    document.getElementById('phone-number').textContent = data.phoneNumber;
                    document.getElementById('description').textContent = data["custom:descriptionText"];
                })
                .catch(error => console.error('Error:', error));


        };
    </script>
</body>

</html>